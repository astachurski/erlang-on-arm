/*
 * beam_emu.c
 *
 *  Created on: Oct 26, 2013
 *      Author: Studnicki
 */

#include "global.h"
#include "beam_emu.h"

void go(BeamInstr* start) {
	register Eterm x0;
	register Eterm* reg = NULL;
	register BeamInstr *I = NULL;


	void* jump_table[154];
	jump_table[1] = &&lb_LABEL;
	jump_table[2] = &&lb_FUNC_INFO;
	jump_table[6] = &&lb_CALL_ONLY;
	jump_table[19] = &&lb_RETURN;
	jump_table[43] = &&lb_IS_EQ_EXACT;
	jump_table[64] = &&lb_MOVE;
	jump_table[78] = &&lb_CALL_EXT_ONLY;
	jump_table[125] = &&lb_GC_BIF2;
	jump_table[153] = &&lb_LINE;

	I = start;
	char buf[256];
	emulator_loop:

	sprintf(buf, "%d\n", unsigned_val(*I));
	debug(buf);
	GotoOp(unsigned_val(*I));

	//1 label/1
	OpCase(LABEL):
		debug("label\n");
		I+=2;
		Loop();
	//2 func_info/2
	OpCase(FUNC_INFO):
		debug("func_info\n");
		I+=3;
		Loop();
	//6 call_only/2
	OpCase(CALL_ONLY):
		debug("call_only\n");
		I+=3;
		Loop();
	//19 return/0
	OpCase(RETURN):
		debug("return\n");
		I+=1;
		return;
	//43 is_eq_exact/3
	OpCase(IS_EQ_EXACT):
		debug("is_eq_exact\n");
		I+=4;
		Loop();
	//64 move/2
	OpCase(MOVE):
		debug("move\n");
		I+=3;
		Loop();
	//78 call_ext_only/2
	OpCase(CALL_EXT_ONLY):
		debug("call_ext_only\n");
		I+=3;
		Loop();
	//125 gc_bif_2/6
	OpCase(GC_BIF2):
		debug("gc_bif2\n");
		I+=7;
		Loop();
	//153 line/1
	OpCase(LINE):
		debug("line\n");
		I+=2;
		Loop();
}
